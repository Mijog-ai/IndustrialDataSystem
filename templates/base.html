<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Industrial Data System{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('dashboard') if session.get('access_token') else url_for('login') }}">Industrial Data System</a>
        <div class="d-flex">
          {% if session.get('access_token') %}
          <form action="{{ url_for('logout') }}" method="post" class="d-flex">
            <button class="btn btn-outline-light" type="submit">Logout</button>
          </form>
          {% endif %}
        </div>
      </div>
    </nav>
    <main class="container py-4">
      {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
          <div class="alert-stack">
            {% for category, message in messages %}
              <div class="alert alert-{{ category }}" role="alert">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
    <div class="display-controls" aria-live="polite">
      <button
        class="display-controls__toggle btn btn-outline-secondary btn-sm"
        type="button"
        id="displayControlsToggle"
        aria-expanded="false"
        aria-controls="displayControlsPanel"
      >
        <span class="me-2" aria-hidden="true">Aa</span>
        Display settings
      </button>
      <div class="display-controls__panel" id="displayControlsPanel" hidden>
        <label for="fontSizeSlider" class="form-label mb-1">Text size</label>
        <div class="d-flex align-items-center gap-2">
          <span class="small" aria-hidden="true">A</span>
          <input
            type="range"
            class="form-range flex-grow-1"
            id="fontSizeSlider"
            min="90"
            max="125"
            step="5"
            value="100"
            aria-describedby="fontSizeValue"
          >
          <span class="fs-5" aria-hidden="true">A</span>
        </div>
        <p class="display-controls__value mb-0" id="fontSizeValue">100%</p>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const root = document.documentElement;
        const slider = document.getElementById('fontSizeSlider');
        const valueLabel = document.getElementById('fontSizeValue');
        const toggle = document.getElementById('displayControlsToggle');
        const panel = document.getElementById('displayControlsPanel');

        const applyScale = (scale) => {
          root.style.setProperty('--font-scale', scale);
          if (valueLabel) {
            valueLabel.textContent = `${scale}%`;
          }
        };

        const storedScale = localStorage.getItem('ids-font-scale');
        if (storedScale) {
          slider.value = storedScale;
          applyScale(storedScale);
        } else {
          applyScale(slider.value);
        }

        slider.addEventListener('input', (event) => {
          const scale = event.target.value;
          applyScale(scale);
          localStorage.setItem('ids-font-scale', scale);
        });

        slider.addEventListener('wheel', (event) => {
          event.preventDefault();
          const { min, max, step } = slider;
          const direction = event.deltaY > 0 ? 1 : -1;
          const stepValue = Number(step) || 1;
          const nextValue = Math.min(
            Number(max),
            Math.max(Number(min), Number(slider.value) + direction * stepValue)
          );
          if (nextValue !== Number(slider.value)) {
            slider.value = String(nextValue);
            slider.dispatchEvent(new Event('input', { bubbles: true }));
          }
        }, { passive: false });

        toggle.addEventListener('click', () => {
          const willShow = panel.hasAttribute('hidden');
          if (willShow) {
            panel.removeAttribute('hidden');
          } else {
            panel.setAttribute('hidden', '');
          }
          toggle.setAttribute('aria-expanded', willShow ? 'true' : 'false');
        });
      });
    </script>
  </body>
</html>
